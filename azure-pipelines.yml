# https://aka.ms/yaml
trigger:
- main
pr:
- main

pool:
  vmImage: 'windows-latest'

steps:
# use chrissy's script to create allcommands.ps1
# https://blog.netnerds.net/2018/12/even-faster-powershell-module-loading/
- task: PowerShell@2
  displayName: Write allcommands.ps1
  inputs:
    targetType: 'inline'
    script: |
      Set-Content -Encoding UTF8 -Path .\allcommands.ps1 -Value "### DO NOT EDIT THIS FILE DIRECTLY ###"
      Get-ChildItem -Path ".\functions\*.ps1" -Recurse | Get-Content | Add-Content .\allcommands.ps1
      Get-ChildItem -Path ".\internal\functions\*.ps1" -Recurse | Get-Content | Add-Content .\allcommands.ps1
# only pack the stuff we want so our package isn't 215 MBs!
- task: PowerShell@2
  displayName: prepare files for nuget package
  inputs:
    targetType: 'inline'
    script: |
      Copy-item *.* $(Pipeline.Workspace)/b -exclude *.yml
      Copy-item .\bin $(Pipeline.Workspace)/b -Recurse
      Copy-item .\en-us $(Pipeline.Workspace)/b -Recurse
      Copy-item .\functions $(Pipeline.Workspace)/b -Recurse
      Copy-item .\internal $(Pipeline.Workspace)/b -Recurse
      Copy-item .\optional $(Pipeline.Workspace)/b -Recurse
      Copy-item .\xml $(Pipeline.Workspace)/b -Recurse

- task: NuGetCommand@2
  displayName: Nuget Pack
  inputs:
    command: 'pack'
    packagesToPack: '$(Pipeline.Workspace)/b/dbatools.nuspec'
    versioningScheme: 'byPrereleaseNumber'
    majorVersion: '1'
    minorVersion: '0'
    patchVersion: '116'

- task: NuGetCommand@2
  displayName: Nuget Push
  condition: eq(variables['Build.SourceBranch'],'refs/heads/main')
  inputs:
    command: 'push'
    packagesToPush: '$(Build.ArtifactStagingDirectory)/**/*.nupkg;!$(Build.ArtifactStagingDirectory)/**/*.symbols.nupkg'
    nuGetFeedType: 'internal'
    publishVstsFeed: 'cbb2d910-3718-48fa-97a7-95df7049ca3f'

- task: PublishPipelineArtifact@1
  displayName: Upload pipeline staging directory
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)'
    artifact: 'Staging directory'
    publishLocation: 'pipeline'

- task: PublishPipelineArtifact@1
  displayName: Upload pipeline workspace for debugging purposes
  condition: and(eq(variables['system.pullRequest.sourceBranch'],'refs/heads/azure-pipelines'),
  inputs:
    targetPath: '$(Pipeline.Workspace)'
    artifact: 'Workspace'
    publishLocation: 'pipeline'